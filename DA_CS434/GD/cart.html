<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Giỏ hàng — Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="page-cart">
  <!-- Header -->
  <header>
    <div class="container header-row">
      <div class="logo"><a href="index.html">Nessa House</a></div>
      <nav>
        <ul>
          <li><a href="index.html">Trang chủ</a></li>
          <li><a href="product.html">Sản phẩm</a></li>
          <li><a href="login.html">Đăng nhập</a></li>
          <li><a href="register.html">Đăng ký</a></li>
        </ul>
      </nav>
      <a class="icon-btn" href="cart.html" aria-label="Giỏ hàng">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 7h10l1.5 13H5.5L7 7Z" stroke="currentColor" stroke-width="1.6"/><path d="M9 9V6a3 3 0 1 1 6 0v3" stroke="currentColor" stroke-width="1.6"/></svg>
        <span id="cart-badge" class="badge">0</span>
      </a>
    </div>
  </header>

  <div class="container pagehead">
    <h1>Giỏ hàng của bạn</h1>
  </div>

  <div class="container layout">
    <!-- Cart list -->
    <section class="card">
      <div class="card-h">Sản phẩm</div>
      <div class="card-b">
        <div id="cart-list" class="cart-list"></div>
        <div id="empty" class="empty" style="display:none">Giỏ hàng trống. <a href="index.html#products" style="color:var(--primary);font-weight:700">Tiếp tục mua sắm</a>.</div>
      </div>
    </section>

    <!-- Summary -->
    <aside class="card">
      <div class="card-h">Tóm tắt đơn hàng</div>
      <div class="card-b">
        <div class="code">
          <input id="coupon" placeholder="Nhập mã giảm giá (ví dụ: SALE10)" />
          <button id="apply" class="btn" type="button">Áp dụng</button>
        </div>

        <div class="sum-row"><span>Tạm tính</span><span id="sub" class="muted">0k</span></div>
        <div class="sum-row"><span>Giảm giá</span><span id="disc" class="muted">0k</span></div>
        <div class="sum-row"><span>Phí vận chuyển</span><span id="ship" class="muted">30k</span></div>
        <hr style="border:none;border-top:1px solid var(--border);margin:10px 0">
        <div class="sum-row"><span class="total">Tổng cộng</span><span id="total" class="total">0k</span></div>

        <div class="mini">
          <a class="btn outline small" href="product.html">← Tiếp tục mua sắm</a>
          <button class="btn" id="checkout" type="button">Thanh toán</button>
        </div>
      </div>
    </aside>
  </div>

<script>
const API_BASE = 'https://localhost:5001';

const $  = (q, r=document)=>r.querySelector(q);
const $$ = (q, r=document)=>[...r.querySelectorAll(q)];
const fmtK   = k => k.toLocaleString('vi-VN') + 'k';
const fmtVND = v => v.toLocaleString('vi-VN') + 'đ';

function getToken(){ return localStorage.getItem('authToken'); }
function getCartItems(){
  try { return JSON.parse(localStorage.getItem('cartItems') || '[]'); }
  catch { return []; }
}
function setCartItems(items){
  localStorage.setItem('cartItems', JSON.stringify(items));
  localStorage.setItem('cartCount', String(items.reduce((a,b)=>a+(b.qty||1),0)));
  updateBadge();
}

function updateBadge(){
  const badge = $('#cart-badge');
  if (badge) badge.textContent = localStorage.getItem('cartCount') || '0';
}

function renderCart(){
  const items = getCartItems();
  const tbody = $('#cart-body'); if(!tbody) return;
  tbody.innerHTML = '';

  items.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${fmtK(p.price || 0)}</td>
      <td><input type="number" min="1" value="${Math.max(1, p.qty||1)}" data-idx="${i}" class="qty"></td>
      <td>${fmtK((p.price||0) * (p.qty||1))}</td>
      <td><button class="rm" data-idx="${i}" aria-label="Xóa">X</button></td>`;
    tbody.appendChild(tr);
  });

  // qty change
  $$('.qty').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const idx = +inp.dataset.idx;
      const items = getCartItems();
      const v = Math.max(1, parseInt(inp.value || '1', 10) || 1);
      items[idx].qty = v;
      setCartItems(items);
      renderCart();
    });
  });

  // remove item
  $$('.rm').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const idx = +btn.dataset.idx;
      const items = getCartItems();
      items.splice(idx, 1);
      setCartItems(items);
      renderCart();
    });
  });

  calcTotals();
}

function calcTotals(){
  const items = getCartItems();
  const subVnd = items.reduce((s,p)=> s + (p.price||0) * 1000 * (p.qty||1), 0);
  const shipVnd = 30000;
  const coupon  = $('#coupon')?.value.trim() || '';

  const elSubtotal = $('#subtotal');
  const elShipping = $('#shipping');
  const elDiscount = $('#discount');
  const elTotal    = $('#total');

  if (elSubtotal) elSubtotal.textContent = fmtVND(subVnd);
  if (elShipping) elShipping.textContent = fmtVND(shipVnd);
  if (elDiscount) elDiscount.textContent = coupon ? '-?' : '0đ'; // hiển thị tạm, server sẽ tính thật
  if (elTotal)    elTotal.textContent    = fmtVND(Math.max(0, subVnd + shipVnd)); // không trừ coupon ở client
}

let isCheckingOut = false;
async function doCheckout(){
  if (isCheckingOut) return;
  const token = getToken();
  if(!token){
    alert('Vui lòng đăng nhập trước khi thanh toán.');
    location.href = 'login.html';
    return;
  }

  const raw = getCartItems();
  if(!raw.length){ alert('Giỏ hàng trống.'); return; }

  // chuẩn hóa payload theo API: priceK là đơn vị "k"
  const items = raw.map(x => ({
    variantId: x.id,
    name: x.name,
    qty: Math.max(1, x.qty||1),
    priceK: x.price || 0
  }));

  const receiverName    = $('#receiver-name')?.value?.trim() || 'Khách hàng';
  const receiverPhone   = $('#receiver-phone')?.value?.trim() || '';
  const receiverAddress = $('#receiver-address')?.value?.trim() || '';
  const coupon          = $('#coupon')?.value?.trim() || '';

  // disable nút để tránh double-click
  const btn = $('#checkout');
  if (btn) { btn.disabled = true; btn.textContent = 'Đang xử lý...'; }
  isCheckingOut = true;

  try{
    const res = await fetch(`${API_BASE}/api/orders/checkout`, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ items, coupon, receiverName, receiverPhone, receiverAddress })
    });

    if (res.status === 401){
      alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
      localStorage.removeItem('authToken');
      location.href = 'login.html';
      return;
    }

    if(!res.ok){
      // cố gắng đọc JSON lỗi, nếu không có thì đọc text
      let msg = '';
      try { const j = await res.json(); msg = j?.message || JSON.stringify(j); }
      catch { msg = await res.text(); }
      alert('Thanh toán thất bại: ' + (msg || res.status));
      return;
    }

    const data = await res.json();
    alert('Đặt hàng thành công! Mã đơn: ' + data.orderId);

    // reset giỏ
    localStorage.removeItem('cartItems');
    localStorage.setItem('cartCount', '0');
    updateBadge();
    renderCart();
  }catch(err){
    console.error(err);
    alert('Không thể kết nối máy chủ.');
  }finally{
    isCheckingOut = false;
    if (btn) { btn.disabled = false; btn.textContent = 'Thanh toán'; }
  }
}

// Events
$('#checkout')?.addEventListener('click', doCheckout);
$('#coupon')?.addEventListener('input', calcTotals);

// Init
updateBadge();
renderCart();
</script>

</body>
</html>
